<!DOCTYPE html>
<html>
  <head>
    <title>Dropbox JavaScript SDK</title>
    <link rel="stylesheet" href="css/fontawesome-5-all.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.js"></script>
    <script src="lib/acorn.js"></script>
    <script src="lib/paper-full.min.js"></script>
    <script src="lib/jquery.min.js"></script>
    <script src="lib/Dropbox-sdk.min.js"></script>
    <script src="lib/utils.js"></script>
  </head>
  <body>
    <div id="app">
      <canvas
        id="canvas"
        resize=""
        keepalive="true"
        width="2504"
        height="2000"
        style="-webkit-user-drag: none; user-select: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"
      ></canvas>
      <div id="gui-top">
        <a href="" id="authlink" class="button">Login to Dropbox</a>
        <div id="undo" class="fas fa-undo block"></div>
        <div id="redo" class="fas fa-redo block"></div>
        <div id="clear-canvas" class="fas fa-trash block"></div>
      </div>
    </div>

    <script>
      var dev = true

      var CLIENT_ID = "zur0pmjfpxq68d5"

      var authenticationUrl = dev ? "http://localhost:90/pen-gen/" : "https://eeropic.github.io/pen-gen/"

      var savedAuth = localStorage.getItem("pengen-dropbox-auth")
      //var savedAuth = null

      function getAccessTokenFromUrl() {
        return utils.parseQueryString(window.location.hash).access_token
      }

      function isAuthenticated() {
        if (savedAuth != null) {
          return true
        } else {
          return !!getAccessTokenFromUrl()
        }
      }

      if (isAuthenticated()) {
        if (savedAuth == null) localStorage.setItem("pengen-dropbox-auth", window.location.href)
        else window.location.href = savedAuth
        var dbx = new Dropbox({ accessToken: getAccessTokenFromUrl() })
        dbx
          .filesListFolder({ path: "/pen-gen/" })
          .then(function(response) {
            globaalit = response.entries
            console.log(response.entries)
          })
          .catch(function(error) {
            console.error(error)
          })
        document.getElementById("authlink").innerHTML = "Logged in to Dropbox"
        document.getElementById("authlink").classList.add("logged")
      } else {
        console.log("nulli " + !savedAuth)
        var dbx = new Dropbox({ clientId: CLIENT_ID })
        var authUrl = dbx.getAuthenticationUrl(authenticationUrl)
        document.getElementById("authlink").href = authUrl
      }
    </script>

    <script>
      paper.install(window)
      window.onload = function() {
        jQuery.get(
          "js/main.js",
          function(data) {
            paper.execute(data)
          },
          "text"
        )

        // Setup directly from canvas id:
        paper.setup("canvas")
        document.body.addEventListener("touchstart", null, { passive: false })
        document.body.addEventListener("touchmove", null, { passive: false })
        document.body.addEventListener("touchend", null, { passive: false })

        $("#gui, #components, #commands, #colors").on("touchstart touchmove", function(e) {
          e.preventDefault()
        })

        function updateUndoButtons(tool) {
          $("#undo").css("opacity", tool.history.index > 0 && tool.history.projects.length > 0 ? 1 : 0.5)
          $("#redo").css("opacity", tool.history.index < tool.history.projects.length - 1 ? 1 : 0.5)
        }

        function handleUndoHistory(tool) {
          tool.history.projects.push(project.exportJSON(false))
          tool.history.index = Math.min(tool.history.index + 1, tool.history.projects.length - 1)
          if (tool.history.projects.length > 0 && tool.history.index < Math.max(0, tool.history.projects.length - 1)) {
            tool.history.projects.length = Math.max(1, tool.history.index)
            tool.history.projects.push(project.exportJSON(false))
            tool.history.index = tool.history.projects.length - 1
          } else if (tool.history.projects.length > tool.maxUndoLevels) {
            tool.history.projects.shift()
            tool.history.index = Math.max(0, tool.history.index - 1)
          }
        }

        $("#clear-canvas").click(function() {
          project.clear()
          handleUndoHistory(penTool)
          updateUndoButtons(penTool)
        })

        $("#undo").click(function() {
          penTool.history.index = Math.max(0, penTool.history.index - 1)
          project.clear()
          project.importJSON(penTool.history.projects[penTool.history.index])
          //logHistory()
          updateUndoButtons(penTool)
        })

        $("#redo").click(function() {
          penTool.history.index = Math.max(0, Math.min(penTool.history.projects.length - 1, penTool.history.index + 1))
          project.clear()
          project.importJSON(penTool.history.projects[penTool.history.index])
          //logHistory()
          updateUndoButtons(penTool)
        })

        function logHistory() {
          console.log("i " + penTool.history.index, "len " + penTool.history.projects.length)
        }

        $(window).on("unload", function(event) {
          localStorage.setItem("touchProto", JSON.stringify(project.exportJSON({ asString: true })))
          localStorage.setItem("touchText", $("#textInputField").val())
          localStorage.setItem("touchCommands", JSON.stringify(getCommands("#commands")))
        })
      }
    </script>
  </body>
</html>
